---
title: "BN 21-22 Assignment 1"
author: "Niek Derksen"
date: "9/29/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)
```

## **Libraries**

### Course package

```{r, echo=FALSE}
install.packages(c("remotes","pROC","naivebayes","ranger"))
remotes::install_github("jtextor/bayesianNetworks")
library(bayesianNetworks)
```

### CRAN

```{r, echo=FALSE}
install.packages(c("funModeling","tidyverse","Hmisc", "bnlearn", "naivebayes", "dagitty", "dataPreparation", "lavaan", "summarytools", "OneR"), dependencies = TRUE)
library(funModeling) 
library(tidyverse) 
library(Hmisc)
library(bnlearn)
library(naivebayes)
library(dagitty)
library(dataPreparation)
library(lavaan)
library(summarytools)
library(OneR)
```

# **Data**

## Import

I assume the "heart_failure_clinical_records_dataset.csv"-file from [this](https://www.kaggle.com/andrewmvd/heart-failure-clinical-data/download) Kaggle page is present in the current working directory.

```{r, echo=TRUE}
d1=read.table("./heart_failure_clinical_records_dataset.csv", sep=',', header=TRUE)
```

## Exploration

```{r}
print(freq(d1), method='render')
```

```{r}
print(dfSummary(d1, plain.ascii  = FALSE,
          style        = 'grid',
          graph.magnif = 0.85,
          varnumbers = FALSE,
          valid.col    = FALSE,
          tmp.img.dir  = "/Rtmp"), method='render')
```

Good all data seems complete. Lets check data type:

```{r}
describe(d1)
```

```{r}
plot_num(d1)
```

### Pre-processing

#### Renaming long variables

```{r}
d1 <- rename(d1, heart_failure = DEATH_EVENT)
d1 <- rename(d1, cpk = creatinine_phosphokinase)
d1 <- rename(d1, srm_creatinine = serum_creatinine)
d1 <- rename(d1, srm_sodium = serum_sodium)
```

#### Factorizing continuous data

We are gonna need to do some pre-processing in order for the SEM to fit, since our data-set is a combination of binary and continuous data. This means we will need polychoric correlation matrices (Pearson, 1900) to test whether the implied conditional independencies of the model hold in the data.

We first have to bin the continuous variables:

```{r}
#create a copy of data_set for reference
d1_proc = data.frame(d1)
```

##### Ordering Binary Variables

```{r}
d1_proc$anaemia <- as.numeric(ordered(d1$anaemia))
d1_proc$sex <- as.numeric(ordered(d1$sex))
d1_proc$high_blood_pressure <- as.numeric(ordered(d1$high_blood_pressure))
d1_proc$diabetes <- as.numeric(ordered(d1$diabetes))
d1_proc$smoking <- as.numeric(ordered(d1$smoking))
d1_proc$heart_failure <- as.numeric(ordered(d1$heart_failure))
```

##### Age

```{r}
#create copy of dataset and label each row with a corresponding age bin
temp_age <- rep("<97", nrow(d1_proc)) #96 is max age
temp_age[d1_proc$age >=0 & d1_proc$age <50] <- "<50"
temp_age[d1_proc$age >=50 & d1_proc$age <60] <- "50-60"
temp_age[d1_proc$age >=60 & d1_proc$age <70] <- "60-70"
temp_age[d1_proc$age >=70 & d1_proc$age <80] <- "70-80"
temp_age[d1_proc$age >=80 & d1_proc$age<90] <- "80-90"
temp_age[d1_proc$age >=90] <- "90>"
#turn binned data into factor:
d1_proc$age <- factor(temp_age, ordered=TRUE, levels=c("<50","50-60","60-70","70-80","80-90","90>"))
```

##### CPK

```{r}
#create copy of dataset and label each row with a corresponding age bin
temp_cpk <- rep("<7862", nrow(d1_proc)) #96 is max cpk
temp_cpk[d1_proc$cpk >=0 & d1_proc$cpk <200] <- "0-200"
temp_cpk[d1_proc$cpk >=200 & d1_proc$cpk <400] <- "200-400"
temp_cpk[d1_proc$cpk >=400 & d1_proc$cpk <600] <- "400-600"
temp_cpk[d1_proc$cpk >=600 & d1_proc$cpk <800] <- "600-800"
temp_cpk[d1_proc$cpk >=800 & d1_proc$cpk <1000] <- "800-1000"
temp_cpk[d1_proc$cpk >=1000 & d1_proc$cpk <1200] <- "1000-1200"
temp_cpk[d1_proc$cpk >=1200 & d1_proc$cpk <1400] <- "1200-1400"
temp_cpk[d1_proc$cpk >=1400 & d1_proc$cpk <1600] <- "1400-1600"
temp_cpk[d1_proc$cpk >=1600 & d1_proc$cpk <1800] <- "1600-1800"
temp_cpk[d1_proc$cpk >=1800 & d1_proc$cpk <2000] <- "1800-2000"
temp_cpk[d1_proc$cpk >=2000] <- "2000>"
#turn binned data into factor:
d1_proc$cpk <- factor(temp_cpk, ordered=TRUE, levels=c("0-200", "200-400", "400-600", "600-800","800-1000","1000-1200","1200-1400","1400-1600","1600-1800","1800-2000","2000>"))
```

##### Ejection Fraction

```{r}
#create copy of dataset and label each row with a corresponding ef bin
temp_ef <- rep("<81", nrow(d1_proc)) #80 is max ef
temp_ef[d1_proc$ejection_fraction >=0  & d1_proc$ejection_fraction <20] <- "<20"
temp_ef[d1_proc$ejection_fraction >=20 & d1_proc$ejection_fraction <30] <- "20-30"
temp_ef[d1_proc$ejection_fraction >=30 & d1_proc$ejection_fraction <40] <- "30-40"
temp_ef[d1_proc$ejection_fraction >=40 & d1_proc$ejection_fraction <50] <- "40-50"
temp_ef[d1_proc$ejection_fraction >=50 & d1_proc$ejection_fraction <60] <- "50-60"
temp_ef[d1_proc$ejection_fraction >=60] <- "60>"
#turn binned data into factor:
d1_proc$ejection_fraction <- factor(temp_ef, ordered=TRUE, levels=c("<20","20-30","30-40","40-50","50-60","60>"))
```

##### Platelets

```{r}
#create copy of dataset and label each row with a corresponding platelets bin
temp_plt <- rep("<850k", nrow(d1_proc)) #850k is max platelets
temp_plt[d1_proc$platelets >=0  & d1_proc$platelets <50000] <- "<50k"
temp_plt[d1_proc$platelets >=50000  & d1_proc$platelets <100000] <- "50k-100k"
temp_plt[d1_proc$platelets >=100000  & d1_proc$platelets <150000] <- "100k-150k"
temp_plt[d1_proc$platelets >=150000  & d1_proc$platelets <200000] <- "150k-200k"
temp_plt[d1_proc$platelets >=200000  & d1_proc$platelets <250000] <- "200k-250k"
temp_plt[d1_proc$platelets >=250000  & d1_proc$platelets <300000] <- "250k-300k"
temp_plt[d1_proc$platelets >=300000  & d1_proc$platelets <350000] <- "300k-350k"
temp_plt[d1_proc$platelets >=350000  & d1_proc$platelets <400000] <- "350k-400k"
temp_plt[d1_proc$platelets >=400000  & d1_proc$platelets <450000] <- "400k-450k"
temp_plt[d1_proc$platelets >=450000  & d1_proc$platelets <500000] <- "450k-500k"
temp_plt[d1_proc$platelets >=500000] <- "500k>"
#turn binned data into factor:
d1_proc$ejection_fraction <- factor(temp_plt, ordered=TRUE, levels=c("<50k","50k-100k","100k-150k","150k-200k","200k-250k","250k-300k","300k-350k","350k-400k","400k-450k","450k-500k","500k>"))
```

##### Serum-Creatinine

```{r}
#create copy of dataset and label each row with a corresponding sc bin
temp_sc <- rep("<9.5", nrow(d1_proc)) #850k is max platelets
temp_sc[d1_proc$srm_creatinine >=0  & d1_proc$srm_creatinine <1.0] <- "<1.0"
temp_sc[d1_proc$srm_creatinine >=1.0  & d1_proc$srm_creatinine <1.5] <- "1.0-1.5"
temp_sc[d1_proc$srm_creatinine >=1.5  & d1_proc$srm_creatinine <2.0] <- "1.5-2.0"
temp_sc[d1_proc$srm_creatinine >=2.0  & d1_proc$srm_creatinine <2.5] <- "2.0-2.5"
temp_sc[d1_proc$srm_creatinine >=2.5  & d1_proc$srm_creatinine <3.0] <- "2.5-3.0"
temp_sc[d1_proc$srm_creatinine >=3.0  & d1_proc$srm_creatinine <3.5] <- "3.0-3.5"
temp_sc[d1_proc$srm_creatinine >=3.5  & d1_proc$srm_creatinine <4.0] <- "3.5-4.0"
temp_sc[d1_proc$srm_creatinine >=4.0] <- "4.0>"
d1_proc$srm_creatinine <- factor(temp_sc, ordered=TRUE, levels=c("<1.0","1.0-1.5","1.5-2.0","2.0-2.5","2.5-3.0","3.0-3.5","3.5-4.0","4.0>"))
```

##### Serum-sodium

```{r}
#create copy of dataset and label each row with a corresponding ss bin
temp_ss <- rep("<149", nrow(d1_proc)) #148 is max serum_sodium
temp_ss[d1_proc$srm_sodium >=0  & d1_proc$srm_sodium <125] <- "<125"
temp_ss[d1_proc$srm_sodium >=125  & d1_proc$srm_sodium <130] <- "125-130"
temp_ss[d1_proc$srm_sodium >=130  & d1_proc$srm_sodium <135] <- "130-135"
temp_ss[d1_proc$srm_sodium >=135  & d1_proc$srm_sodium <140] <- "135-140"
temp_ss[d1_proc$srm_sodium >=140  & d1_proc$srm_sodium <145] <- "140-145"
temp_ss[d1_proc$srm_sodium >=145] <- "145>"
d1_proc$srm_sodium <- factor(temp_ss, ordered=TRUE, levels=c("<125","125-130", "130-135", "135-140","140-145","145>"))
```

##### Time

```{r}
#create copy of dataset and label each row with a corresponding time bin
temp_time <- rep("<286", nrow(d1_proc)) #285 is max time
temp_time[d1_proc$time >=0  & d1_proc$time <30] <- "<30"
temp_time[d1_proc$time >=30  & d1_proc$time <60] <- "30-60"
temp_time[d1_proc$time >=60  & d1_proc$time <90] <- "60-90"
temp_time[d1_proc$time >=90  & d1_proc$time <120] <- "90-120"
temp_time[d1_proc$time >=120  & d1_proc$time <150] <- "120-150"
temp_time[d1_proc$time >=150  & d1_proc$time <180] <- "150-180"
temp_time[d1_proc$time >=180  & d1_proc$time <210] <- "180-210"
temp_time[d1_proc$time >=210  & d1_proc$time <240] <- "210-240"
temp_time[d1_proc$time >=240  & d1_proc$time <270] <- "240-270"
temp_time[d1_proc$time >=270] <- "270>"

d1_proc$time <- factor(temp_time, ordered=TRUE, levels=c("<30","30-60","60-90","90-120","120-150","150-180","180-210","210-240","240-270","270>"))
```

lets check the data types again:

```{r}
print(status(d1))
```

There seem to be no N/A's or transformation issues. Data pre-processing complete!

### Relationship check

Create a simple linear model to check some relationships:

```{r}
lin_mdl <- lm(heart_failure ~ age + anaemia + cpk + diabetes + ejection_fraction + high_blood_pressure + platelets + srm_creatinine + srm_sodium + sex + smoking + time, data=data.frame(d1_proc))
coef(lin_mdl)
summary(lin_mdl)
```

Not sure what to do with time here. Just took it along. The most significant effects are:

-   age

-   anaemia

-   ejection_fraction

-   serum_creatinine

-   time

Linear regression model is a bad fit -\> Multiple adjusted R-squared 0.3924.

# Model Graph structures

I've devised the following Occam's Razor model. V1.

Defining the above model in dagitty syntax:

```{r}
g1 <- graphLayout(dagitty('dag {
bb="0,0,1,1"
age [pos="0.213,0.767"]
anaemia [pos="0.913,0.191"]
cpk [pos="0.814,0.701"]
diabetes [pos="0.387,0.127"]
ejection_fraction [pos="0.526,0.237"]
heart_failure [pos="0.504,0.491"]
high_blood_pressure [pos="0.661,0.123"]
platelets [pos="0.761,0.379"]
sex [pos="0.385,0.926"]
smoking [pos="0.523,0.027"]
srm_creatinine [pos="0.677,0.933"]
srm_sodium [pos="0.128,0.495"]
time [pos="0.196,0.265"]
age -> heart_failure
anaemia -> platelets
cpk -> heart_failure
diabetes -> ejection_fraction
ejection_fraction -> heart_failure
heart_failure -> srm_sodium
heart_failure -> time
high_blood_pressure -> ejection_fraction
platelets -> heart_failure
sex -> heart_failure
smoking -> high_blood_pressure
srm_creatinine -> heart_failure
}
'
))
```

```{r}
plot(g1)
```

Anemia can cause lower level of blood platelets & obesity is an unobserved variable.

# Testing Models

## Chi-square

First we perform local tests using d-separation statements to test the model.

```{r}
corr <- lavCor(d1_proc)
varTable(d1_proc)
independency_test<-localTests(g1, sample.cov=corr, sample.nobs=nrow(d1_proc))
print(independency_test)

plotLocalTestResults(independency_test)
```

```{r}
independency_test2<-localTests(g1, sample.cov=corr, sample.nobs=nrow(d1_proc), max.conditioning.variables = 2)
print(independency_test2)

plotLocalTestResults(independency_test2)
```

## SEM

```{r}
status(d1_proc)
```

```{r}
polychoric <- lavCor(d1_proc)
localTests(g1, sample.cov=polychoric, sample.nobs=nrow(d1_proc))

sem_model1 <- toString(g1, "lavaan")
fitted_sem <- sem(sem_model1, sample.cov=polychoric, sample.nobs=nrow(d1_proc))
summary(fit, standardized=TRUE)
```

Lets check the model selection criteria

```{r}
print(coef(fitted_sem), method='render')
print(summary(fitted_sem, fit.measures=TRUE, rsquare=TRUE, standardize=TRUE), method='render')
fitmeasures(fitted_sem)
```

Model diagnostics, so we can see which variables have low or high loading with heart_failure. These can be considered for removal from the graph.

```{r}
fitted(fitted_sem)
inspect(fitted_sem, what="cor.all")
```

```{r}
resid(fitted_sem, "cor")
plot_matrix <- function(matrix_toplot){
  corrplot::corrplot(matrix_toplot, is.corr = FALSE,
                     type = 'lower',
                     order = "original",
                     tl.col='black', tl.cex=.75)
}
a<- resid(fitted_sem, type = 'cor')$cov
plot_matrix(a)
```

```{r}
lavInspect(fitted_sem, "theta")
print(modindices(fitted_sem))
```

```{r}
modificationindices(fitted_sem, minimum.value = 15)
```

Lets plot the SEM model:

```{r}
x <- lavaan::parTable(fitted_sem)
cg1 <- coordinates(g1)
fg1 <- lavaanToGraph(x, digits = 2)
coordinates(fg1) <- cg1
plot(fg1, show.coefficients = TRUE)
```
