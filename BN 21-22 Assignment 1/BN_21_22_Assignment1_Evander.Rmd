---
title: "BayesianNet_Test"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Install all the packages

```{r} 
install.packages(c("remotes","pROC","naivebayes","ranger"))
remotes::install_github("jtextor/bayesianNetworks")
library(bayesianNetworks)
install.packages(c("funModeling","tidyverse","Hmisc", "bnlearn", "naivebayes", "dagitty", "dataPreparation", "lavaan", "summarytools", "OneR","corrplot"), dependencies = TRUE)
library(funModeling) 
library(tidyverse) 
library(Hmisc)
library(bnlearn)
library(naivebayes)
library(dagitty)
library(dataPreparation)
library(lavaan)
library(summarytools)
library(OneR)
library(corrplot)
```

## Import dataset

```{r }
d1=read.table("./heart_failure_clinical_records_dataset.csv", sep=',', header=TRUE)
```

## Preprocessing 

Some vars shortened
```{r }
d1 <- rename(d1, cpk = creatinine_phosphokinase)
d1 <- rename(d1, srm_creatinine = serum_creatinine)
d1 <- rename(d1, srm_sodium = serum_sodium)
```

```{r }

d1_proc = data.frame(d1)

```

#### Continuous and binary data
Order binary variables


```{r }

d1_proc$anaemia <- as.numeric(ordered(d1$anaemia))
d1_proc$sex <- as.numeric(ordered(d1$sex))
d1_proc$high_blood_pressure <- as.numeric(ordered(d1$high_blood_pressure))
d1_proc$diabetes <- as.numeric(ordered(d1$diabetes))
d1_proc$smoking <- as.numeric(ordered(d1$smoking))
d1_proc$DEATH_EVENT <- as.numeric(ordered(d1$DEATH_EVENT))

```

#### Bin all continuous

```{r }
temp_age <- rep("<97", nrow(d1_proc)) #96 is max age
temp_age[d1_proc$age >=0 & d1_proc$age <50] <- "<50"
temp_age[d1_proc$age >=50 & d1_proc$age <60] <- "50-60"
temp_age[d1_proc$age >=60 & d1_proc$age <70] <- "60-70"
temp_age[d1_proc$age >=70 & d1_proc$age <80] <- "70-80"
temp_age[d1_proc$age >=80 & d1_proc$age<90] <- "80-90"
temp_age[d1_proc$age >=90] <- "90>"
#turn binned data into factor:
d1_proc$age <- ordered(temp_age, levels=c("<50","50-60","60-70","70-80","80-90","90>"))

temp_cpk <- rep("<7862", nrow(d1_proc)) #96 is max cpk
temp_cpk[d1_proc$cpk >=0 & d1_proc$cpk <200] <- "0-200"
temp_cpk[d1_proc$cpk >=200 & d1_proc$cpk <400] <- "200-400"
temp_cpk[d1_proc$cpk >=400 & d1_proc$cpk <600] <- "400-600"
temp_cpk[d1_proc$cpk >=600 & d1_proc$cpk <800] <- "600-800"
temp_cpk[d1_proc$cpk >=800 & d1_proc$cpk <1000] <- "800-1000"
temp_cpk[d1_proc$cpk >=1000 & d1_proc$cpk <1200] <- "1000-1200"
temp_cpk[d1_proc$cpk >=1200 & d1_proc$cpk <1400] <- "1200-1400"
temp_cpk[d1_proc$cpk >=1400 & d1_proc$cpk <1600] <- "1400-1600"
temp_cpk[d1_proc$cpk >=1600 & d1_proc$cpk <1800] <- "1600-1800"
temp_cpk[d1_proc$cpk >=1800 & d1_proc$cpk <2000] <- "1800-2000"
temp_cpk[d1_proc$cpk >=2000] <- "2000>"
#turn binned data into factor:
d1_proc$cpk <- ordered(temp_cpk, levels=c("0-200", "200-400", "400-600", "600-800","800-1000","1000-1200","1200-1400","1400-1600","1600-1800","1800-2000","2000>"))

temp_ef <- rep("<81", nrow(d1_proc)) #80 is max ef
temp_ef[d1_proc$ejection_fraction >=0  & d1_proc$ejection_fraction <20] <- "<20"
temp_ef[d1_proc$ejection_fraction >=20 & d1_proc$ejection_fraction <30] <- "20-30"
temp_ef[d1_proc$ejection_fraction >=30 & d1_proc$ejection_fraction <40] <- "30-40"
temp_ef[d1_proc$ejection_fraction >=40 & d1_proc$ejection_fraction <50] <- "40-50"
temp_ef[d1_proc$ejection_fraction >=50 & d1_proc$ejection_fraction <60] <- "50-60"
temp_ef[d1_proc$ejection_fraction >=60] <- "60>"
#turn binned data into factor:
d1_proc$ejection_fraction <- ordered(temp_ef, levels=c("<20","20-30","30-40","40-50","50-60","60>"))

temp_plt <- rep("<850k", nrow(d1_proc)) #850k is max platelets
temp_plt[d1_proc$platelets >=0  & d1_proc$platelets <50000] <- "<50k"
temp_plt[d1_proc$platelets >=50000  & d1_proc$platelets <100000] <- "50k-100k"
temp_plt[d1_proc$platelets >=100000  & d1_proc$platelets <150000] <- "100k-150k"
temp_plt[d1_proc$platelets >=150000  & d1_proc$platelets <200000] <- "150k-200k"
temp_plt[d1_proc$platelets >=200000  & d1_proc$platelets <250000] <- "200k-250k"
temp_plt[d1_proc$platelets >=250000  & d1_proc$platelets <300000] <- "250k-300k"
temp_plt[d1_proc$platelets >=300000  & d1_proc$platelets <350000] <- "300k-350k"
temp_plt[d1_proc$platelets >=350000  & d1_proc$platelets <400000] <- "350k-400k"
temp_plt[d1_proc$platelets >=400000  & d1_proc$platelets <450000] <- "400k-450k"
temp_plt[d1_proc$platelets >=450000  & d1_proc$platelets <500000] <- "450k-500k"
temp_plt[d1_proc$platelets >=500000] <- "500k>"
#turn binned data into factor
d1_proc$platelets <- ordered(temp_plt, levels=c("<50k","50k-100k","100k-150k","150k-200k","200k-250k","250k-300k","300k-350k","350k-400k","400k-450k","450k-500k","500k>"))

temp_sc <- rep("<9.5", nrow(d1_proc)) #850k is max platelets
temp_sc[d1_proc$srm_creatinine >=0  & d1_proc$srm_creatinine <1.0] <- "<1.0"
temp_sc[d1_proc$srm_creatinine >=1.0  & d1_proc$srm_creatinine <1.5] <- "1.0-1.5"
temp_sc[d1_proc$srm_creatinine >=1.5  & d1_proc$srm_creatinine <2.0] <- "1.5-2.0"
temp_sc[d1_proc$srm_creatinine >=2.0  & d1_proc$srm_creatinine <2.5] <- "2.0-2.5"
temp_sc[d1_proc$srm_creatinine >=2.5  & d1_proc$srm_creatinine <3.0] <- "2.5-3.0"
temp_sc[d1_proc$srm_creatinine >=3.0  & d1_proc$srm_creatinine <3.5] <- "3.0-3.5"
temp_sc[d1_proc$srm_creatinine >=3.5  & d1_proc$srm_creatinine <4.0] <- "3.5-4.0"
temp_sc[d1_proc$srm_creatinine >=4.0] <- "4.0>"
d1_proc$srm_creatinine <- ordered(temp_sc, levels=c("<1.0","1.0-1.5","1.5-2.0","2.0-2.5","2.5-3.0","3.0-3.5","3.5-4.0","4.0>"))

temp_ss <- rep("<149", nrow(d1_proc)) #148 is max serum_sodium
temp_ss[d1_proc$srm_sodium >=0  & d1_proc$srm_sodium <125] <- "<125"
temp_ss[d1_proc$srm_sodium >=125  & d1_proc$srm_sodium <130] <- "125-130"
temp_ss[d1_proc$srm_sodium >=130  & d1_proc$srm_sodium <135] <- "130-135"
temp_ss[d1_proc$srm_sodium >=135  & d1_proc$srm_sodium <140] <- "135-140"
temp_ss[d1_proc$srm_sodium >=140  & d1_proc$srm_sodium <145] <- "140-145"
temp_ss[d1_proc$srm_sodium >=145] <- "145>"
d1_proc$srm_sodium <- ordered(temp_ss, levels=c("<125","125-130", "130-135", "135-140","140-145","145>"))

temp_time <- rep("<286", nrow(d1_proc)) #285 is max time
temp_time[d1_proc$time >=0  & d1_proc$time <30] <- "<30"
temp_time[d1_proc$time >=30  & d1_proc$time <60] <- "30-60"
temp_time[d1_proc$time >=60  & d1_proc$time <90] <- "60-90"
temp_time[d1_proc$time >=90  & d1_proc$time <120] <- "90-120"
temp_time[d1_proc$time >=120  & d1_proc$time <150] <- "120-150"
temp_time[d1_proc$time >=150  & d1_proc$time <180] <- "150-180"
temp_time[d1_proc$time >=180  & d1_proc$time <210] <- "180-210"
temp_time[d1_proc$time >=210  & d1_proc$time <240] <- "210-240"
temp_time[d1_proc$time >=240  & d1_proc$time <270] <- "240-270"
temp_time[d1_proc$time >=270] <- "270>"
d1_proc$time <- ordered(temp_time,  levels=c("<30","30-60","60-90","90-120","120-150","150-180","180-210","210-240","240-270","270>"))


```
## Define model

```{r }
g1 <- graphLayout(dagitty('dag {
bb="0,0,1,1"
age [pos="0.400,0.765"]
anaemia [pos="0.626,0.325"]
cpk [pos="0.643,0.593"]
diabetes [pos="0.381,0.311"]
ejection_fraction [pos="0.521,0.323"]
DEATH_EVENT [pos="0.504,0.491"]
high_blood_pressure [pos="0.526,0.198"]
platelets [pos="0.625,0.448"]
srm_creatinine [pos="0.604,0.734"]
srm_sodium [pos="0.363,0.557"]
sex [pos="0.505,0.770"]
smoking [pos="0.526,0.082"]
time [pos="0.361,0.451"]
age -> DEATH_EVENT
anaemia -> platelets
cpk -> DEATH_EVENT
diabetes -> ejection_fraction
ejection_fraction -> DEATH_EVENT
DEATH_EVENT -> srm_sodium
DEATH_EVENT -> time
high_blood_pressure -> ejection_fraction
platelets -> DEATH_EVENT
srm_creatinine -> DEATH_EVENT
sex -> DEATH_EVENT
smoking -> high_blood_pressure
}
'
))

```

```{r}
plot(g1)
```

```{r}
chi_square_test <- localTests(g1, d1_proc, type = 'cis.chisq')
plotLocalTestResults(chi_square_test)
top_rmsea <- chi_square_test[order(chi_square_test$rmsea,decreasing = TRUE),]
print(top_rmsea)
```

- Sex and smoking are very dependent, research on this checks out; Men smoke way more than women. 
- diabetes  and sex are dependent
- diabetes and smoking are dependent


P_values not significant but somewhat high rmsea:
- Death is not independent from smoking given ejection fraction.
- Anaemia is not independent from serum_.. given platelets
- Death is not independent from anaemia given platelets
- Death is not independent from high blood pressure given ejection fraction
etc.


## Polychoric correlation

Rather than binning continuous variables, we will also perform polychoric correlation, which works with continuous and binary variables. Binary variables will receive an arbitrary ordering. 

## Import dataset

```{r }
d2=read.table("./heart_failure_clinical_records_dataset.csv", sep=',', header=TRUE)
```

## Preprocessing 

Some vars shortened
```{r }
d2 <- rename(d2, cpk = creatinine_phosphokinase)
d2 <- rename(d2, srm_creatinine = serum_creatinine)
d2 <- rename(d2, srm_sodium = serum_sodium)
```

```{r }

d2_proc = data.frame(d2)

```

## Define ordinal catagorical

Age and time have natural ordering

```{r }
temp_age <- rep("<97", nrow(d2_proc)) #96 is max age
temp_age[d2_proc$age >=0 & d2_proc$age <50] <- "<50"
temp_age[d2_proc$age >=50 & d2_proc$age <60] <- "50-60"
temp_age[d2_proc$age >=60 & d2_proc$age <70] <- "60-70"
temp_age[d2_proc$age >=70 & d2_proc$age <80] <- "70-80"
temp_age[d2_proc$age >=80 & d2_proc$age<90] <- "80-90"
temp_age[d2_proc$age >=90] <- "90>"
#turn binned data into factor:
d2_proc$age <- factor(temp_age, ordered=TRUE, levels=c("<50","50-60","60-70","70-80","80-90","90>"))

temp_time <- rep("<286", nrow(d2_proc)) #285 is max time
temp_time[d2_proc$time >=0  & d2_proc$time <30] <- "<30"
temp_time[d2_proc$time >=30  & d2_proc$time <60] <- "30-60"
temp_time[d2_proc$time >=60  & d2_proc$time <90] <- "60-90"
temp_time[d2_proc$time >=90  & d2_proc$time <120] <- "90-120"
temp_time[d2_proc$time >=120  & d2_proc$time <150] <- "120-150"
temp_time[d2_proc$time >=150  & d2_proc$time <180] <- "150-180"
temp_time[d2_proc$time >=180  & d2_proc$time <210] <- "180-210"
temp_time[d2_proc$time >=210  & d2_proc$time <240] <- "210-240"
temp_time[d2_proc$time >=240  & d2_proc$time <270] <- "240-270"
temp_time[d2_proc$time >=270] <- "270>"
d2_proc$time <- factor(temp_time, ordered=TRUE, levels=c("<30","30-60","60-90","90-120","120-150","150-180","180-210","210-240","240-270","270>"))


```

## Define Binary

```{r }

d2_proc$anaemia <-as.integer(d2_proc$anaemia)
d2_proc$diabetes <-as.integer(d2_proc$diabetes)
d2_proc$high_blood_pressure <-as.integer(d2_proc$high_blood_pressure)
d2_proc$sex <-as.integer(d2_proc$sex)
d2_proc$smoking <-as.integer(d2_proc$smoking)
d2_proc$DEATH_EVENT <-as.integer(d2_proc$DEATH_EVENT)

```


## Compute polychoric correlation matrix

```{r }
d2_proc_corr = lavCor(d2_proc)

```


## Test conditional independencies against correlation matrix 

```{r }
corrtest <- localTests(g1, sample.cov = d1_proc_corr, sample.nobs=nrow(d1_proc))
plotLocalTestResults(corrtest)
top_corr <- corrtest[order(corrtest$estimate,decreasing = TRUE),]
print(top_corr)
down_corr <- corrtest[order(corrtest$estimate,decreasing = FALSE),]
print(down_corr)

corrtest <- localTests(g1, sample.cov = d2_proc_corr, sample.nobs=nrow(d2_proc))
plotLocalTestResults(corrtest)
top_corr <- corrtest[order(corrtest$estimate,decreasing = TRUE),]
print(top_corr)
down_corr <- corrtest[order(corrtest$estimate,decreasing = FALSE),]
print(down_corr)
```
Positive correlations
- Similar to the chi-squared test, sex and smoking are strongly correlated.
- Creatine phosphokinase shows correlation with time and death_event.
- Age and serum creatine also show significant correlations.

Negative correlations
- Many given time, are negatively correlated 
- Anaemia and creatine-pk show negative correlation
- Age and creatine-cpk
- diabetes and sex



## Fitting SEM using binned catagorical polychoric correlation matrix


```{r }
cg <- coordinates(g1)

summary(d1_proc)
d1_proc_corr = lavCor(d1_proc)
sem_model <- toString(g1, "lavaan")
fit <- sem("srm_sodium~DEATH_EVENT
           time~DEATH_EVENT
           DEATH_EVENT~age
           platelets~anaemia
           DEATH_EVENT~cpk
           ejection_fraction~diabetes
           DEATH_EVENT~ejection_fraction
           ejection_fraction~high_blood_pressure
           DEATH_EVENT~platelets
           DEATH_EVENT~sex
           high_blood_pressure~smoking
           DEATH_EVENT~srm_creatinine
           smoking ~ sex
           0*diabetes ~~ 0*smoking 
           0*anaemia ~~ 0*age
           0*cpk ~~ 0*sex 
           ", sample.cov = d1_proc_corr, sample.nobs = nrow(d1_proc))
summary(fit, standardized = TRUE, fit.measures = TRUE)
fit_est = parameterEstimates(fit)
print(fit)
top_fit <- fit_est[order(fit_est$est,decreasing = TRUE),]
print(top_fit)

```
```{r}

modificationindices(fit, minimum.value = 5)
x <- lavaan::parTable(fit)
cg1 <- coordinates(g1)
fg1 <- lavaanToGraph(x, digits = 2)
coordinates(fg1) <- cg1
plot(fg1, show.coefficients = TRUE)
```

## Exploring model
```{r}
resid(fit, "cor")
plot_matrix <- function(matrix_toplot){
  corrplot::corrplot(matrix_toplot, is.corr = FALSE,
                     type = 'lower',
                     order = "original",
                     tl.col='black', tl.cex=.75)
}
a<- resid(fit, type = 'cor')$cov
plot_matrix(a)

```



```{r }

for( x in names(g1) ){
  px <- parents( g1, x )
  for( y in px ){
    tst <- bayesianNetworks::ci.test( x, y, setdiff(px,y), data=d1_proc )
    print( paste(y,'->',x, tst$effect, tst$p.value ) )
}
}

```
```{r }
d1=read.table("./heart_failure_clinical_records_dataset.csv", sep=',', header=TRUE)
d1 <- rename(d1, cpk = creatinine_phosphokinase)
d1 <- rename(d1, srm_creatinine = serum_creatinine)
d1 <- rename(d1, srm_sodium = serum_sodium)
d1_proc = data.frame(scale(d1))

sem_test <- toString(g1, "lavaan")

mdl <- sem("srm_sodium~DEATH_EVENT
           time~DEATH_EVENT
           DEATH_EVENT~age
           platelets~anaemia
           DEATH_EVENT~cpk
           ejection_fraction~diabetes
           DEATH_EVENT~ejection_fraction
           ejection_fraction~high_blood_pressure
           DEATH_EVENT~platelets
           DEATH_EVENT~sex
           high_blood_pressure~smoking
           DEATH_EVENT~srm_creatinine
           " , data=d1_proc, fixed.x = FALSE)
summary( mdl )

x <- lavaan::parTable(mdl)
cg1 <- coordinates(g1)
fg1 <- lavaanToGraph(x, digits = 2)
coordinates(fg1) <- cg1
plot(fg1, show.coefficients = TRUE)




mdl <- sem("srm_sodium~DEATH_EVENT
           time~DEATH_EVENT
           DEATH_EVENT~age
           platelets~anaemia
           DEATH_EVENT~cpk
           ejection_fraction~diabetes
           DEATH_EVENT~ejection_fraction
           ejection_fraction~high_blood_pressure
           DEATH_EVENT~platelets
           DEATH_EVENT~sex
           high_blood_pressure~smoking
           DEATH_EVENT~srm_creatinine
           smoking ~ sex
           0*diabetes ~~ 0*smoking 
           0*anaemia ~~ 0*age
           0*cpk ~~ 0*sex 
           " , data=d1_proc, fixed.x = FALSE)
summary( mdl )

x <- lavaan::parTable(mdl)
cg1 <- coordinates(g1)
fg1 <- lavaanToGraph(x, digits = 2)
coordinates(fg1) <- cg1
plot(fg1, show.coefficients = TRUE)
```



"srm_sodium~DEATH_EVENT time~DEATH_EVENT DEATH_EVENT~age platelets~anaemia DEATH_EVENT~cpk ejection_fraction~diabetes  DEATH_EVENT~ejection_fraction ejection_fraction~high_blood_pressure DEATH_EVENT~platelets DEATH_EVENT~sex high_blood_pressure~smoking DEATH_EVENT~srm_creatinine"





