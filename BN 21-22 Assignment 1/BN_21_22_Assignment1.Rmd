---
title: "BN 21-22 Assignment 1"
author: "Niek Derksen"
date: "9/29/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)
```

## **Libraries**

### Course package

```{r, echo=FALSE}
#install.packages(c("remotes","pROC","naivebayes","ranger"))
#remotes::install_github("jtextor/bayesianNetworks")
library(bayesianNetworks)
```

### CRAN

```{r, echo=FALSE}
#install.packages(c("funModeling","tidyverse","Hmisc", "bnlearn", "naivebayes", "dagitty", "dataPreparation", "lavaan", "summarytools", "OneR"), dependencies = TRUE)
library(funModeling) 
library(tidyverse) 
library(Hmisc)
library(bnlearn)
library(naivebayes)
library(dagitty)
library(dataPreparation)
library(lavaan)
library(summarytools)
library(OneR)
library(fastDummies)
```

# **Data**

## Import

I assume the "heart_failure_clinical_records_dataset.csv"-file from [this](https://www.kaggle.com/andrewmvd/heart-failure-clinical-data/download) Kaggle page is present in the current working directory.

```{r, echo=TRUE}
d1=read.table("./heart_failure_clinical_records_dataset.csv", sep=',', header=TRUE)
```

## Exploration

```{r}
print(freq(d1), method='render')
```

```{r}

```

Good all data seems complete. Lets check data type:

```{r}
describe(d1)
```

```{r}
plot_num(d1)
```

### Pre-processing

#### Renaming long variables

```{r}
d1 <- rename(d1, heart_failure = DEATH_EVENT)
d1 <- rename(d1, cpk = creatinine_phosphokinase)
d1 <- rename(d1, srm_creatinine = serum_creatinine)
d1 <- rename(d1, srm_sodium = serum_sodium)
```

#### Factorizing continuous data

We are gonna need to do some pre-processing in order for the SEM to fit, since our data-set is a combination of binary and continuous data. This means we will need polychoric correlation matrices (Pearson, 1900) to test whether the implied conditional independencies of the model hold in the data.

We first have to bin the continuous variables:

```{r}
#create a copy of data_set for reference
d1_proc = data.frame(d1)
```

##### Ordering Binary Variables

```{r}
d1_proc$anaemia <- as.numeric(ordered(d1$anaemia))
d1_proc$sex <- as.numeric(ordered(d1$sex))
d1_proc$high_blood_pressure <- as.numeric(ordered(d1$high_blood_pressure))
d1_proc$diabetes <- as.numeric(ordered(d1$diabetes))
d1_proc$smoking <- as.numeric(ordered(d1$smoking))
d1_proc$heart_failure <- as.numeric(ordered(d1$heart_failure))
```

##### Age

```{r}
#create copy of dataset and label each row with a corresponding age bin
temp_age <- rep("<97", nrow(d1_proc)) #96 is max age
temp_age[d1$age >=0 & d1$age <50] <- "<50"
temp_age[d1$age >=50 & d1$age <60] <- "50-60"
temp_age[d1$age >=60 & d1$age <70] <- "60-70"
temp_age[d1$age >=70 & d1$age <80] <- "70-80"
temp_age[d1$age >=80 & d1$age<90] <- "80-90"
temp_age[d1$age >=90] <- "90>"
#turn binned data into factor:
d1_proc$age <- factor(temp_age, ordered=TRUE, levels=c("<50","50-60","60-70","70-80","80-90","90>"))
summary(d1_proc$age)

```

##### CPK

```{r}
#create copy of dataset and label each row with a corresponding age bin
temp_cpk <- rep("<7862", nrow(d1_proc)) #96 is max cpk
temp_cpk[d1$cpk >=0 & d1$cpk <200] <- "0-200"
temp_cpk[d1$cpk >=200 & d1$cpk <400] <- "200-400"
temp_cpk[d1$cpk >=400 & d1$cpk <600] <- "400-600"
temp_cpk[d1$cpk >=600 & d1$cpk <800] <- "600-800"
temp_cpk[d1$cpk >=800 & d1$cpk <1000] <- "800-1000"
temp_cpk[d1$cpk >=1000 & d1$cpk <1200] <- "1000-1200"
temp_cpk[d1$cpk >=1200 & d1$cpk <1400] <- "1200-1400"
temp_cpk[d1$cpk >=1400 & d1$cpk <1600] <- "1400-1600"
temp_cpk[d1$cpk >=1600 & d1$cpk <1800] <- "1600-1800"
temp_cpk[d1$cpk >=1800 & d1$cpk <2000] <- "1800-2000"
temp_cpk[d1$cpk >=2000] <- "2000>"
#turn binned data into factor:
d1_proc$cpk <- factor(temp_cpk, ordered=TRUE, levels=c("0-200", "200-400", "400-600", "600-800","800-1000","1000-1200","1200-1400","1400-1600","1600-1800","1800-2000","2000>"))
```

##### Ejection Fraction

```{r}
#create copy of dataset and label each row with a corresponding ef bin
temp_ef <- rep("<81", nrow(d1_proc)) #80 is max ef
temp_ef[d1$ejection_fraction >=0  & d1$ejection_fraction <20] <- "<20"
temp_ef[d1$ejection_fraction >=20 & d1$ejection_fraction <30] <- "20-30"
temp_ef[d1$ejection_fraction >=30 & d1$ejection_fraction <40] <- "30-40"
temp_ef[d1$ejection_fraction >=40 & d1$ejection_fraction <50] <- "40-50"
temp_ef[d1$ejection_fraction >=50 & d1$ejection_fraction <60] <- "50-60"
temp_ef[d1$ejection_fraction >=60] <- "60>"
#turn binned data into factor:
d1_proc$ejection_fraction <- factor(temp_ef, ordered=TRUE, levels=c("<20","20-30","30-40","40-50","50-60","60>"))
```

##### Platelets

```{r}
#create copy of dataset and label each row with a corresponding platelets bin
temp_plt <- rep("<850k", nrow(d1_proc)) #850k is max platelets
temp_plt[d1$platelets >=0  & d1$platelets <50000] <- "<50k"
temp_plt[d1$platelets >=50000  & d1$platelets <100000] <- "50k-100k"
temp_plt[d1$platelets >=100000  & d1$platelets <150000] <- "100k-150k"
temp_plt[d1$platelets >=150000  & d1$platelets <200000] <- "150k-200k"
temp_plt[d1$platelets >=200000  & d1$platelets <250000] <- "200k-250k"
temp_plt[d1$platelets >=250000  & d1$platelets <300000] <- "250k-300k"
temp_plt[d1$platelets >=300000  & d1$platelets <350000] <- "300k-350k"
temp_plt[d1$platelets >=350000  & d1$platelets <400000] <- "350k-400k"
temp_plt[d1$platelets >=400000  & d1$platelets <450000] <- "400k-450k"
temp_plt[d1$platelets >=450000  & d1$platelets <500000] <- "450k-500k"
temp_plt[d1$platelets >=500000] <- "500k>"
#turn binned data into factor:
d1_proc$platelets <- factor(temp_plt, ordered=TRUE, levels=c("<50k","50k-100k","100k-150k","150k-200k","200k-250k","250k-300k","300k-350k","350k-400k","400k-450k","450k-500k","500k>"))
```

##### Serum-Creatinine

```{r}
#create copy of dataset and label each row with a corresponding sc bin
temp_sc <- rep("<9.5", nrow(d1_proc)) #850k is max platelets
temp_sc[d1$srm_creatinine >=0  & d1$srm_creatinine <1.0] <- "<1.0"
temp_sc[d1$srm_creatinine >=1.0  & d1$srm_creatinine <1.5] <- "1.0-1.5"
temp_sc[d1$srm_creatinine >=1.5  & d1$srm_creatinine <2.0] <- "1.5-2.0"
temp_sc[d1$srm_creatinine >=2.0  & d1$srm_creatinine <2.5] <- "2.0-2.5"
temp_sc[d1$srm_creatinine >=2.5  & d1$srm_creatinine <3.0] <- "2.5-3.0"
temp_sc[d1$srm_creatinine >=3.0  & d1$srm_creatinine <3.5] <- "3.0-3.5"
temp_sc[d1$srm_creatinine >=3.5  & d1$srm_creatinine <4.0] <- "3.5-4.0"
temp_sc[d1$srm_creatinine >=4.0] <- "4.0>"
d1_proc$srm_creatinine <- factor(temp_sc, ordered=TRUE, levels=c("<1.0","1.0-1.5","1.5-2.0","2.0-2.5","2.5-3.0","3.0-3.5","3.5-4.0","4.0>"))
```

##### Serum-sodium

```{r}
#create copy of dataset and label each row with a corresponding ss bin
temp_ss <- rep("<149", nrow(d1_proc)) #148 is max serum_sodium
temp_ss[d1$srm_sodium >=0  & d1$srm_sodium <125] <- "<125"
temp_ss[d1$srm_sodium >=125  & d1$srm_sodium <130] <- "125-130"
temp_ss[d1$srm_sodium >=130  & d1$srm_sodium <135] <- "130-135"
temp_ss[d1$srm_sodium >=135  & d1$srm_sodium <140] <- "135-140"
temp_ss[d1$srm_sodium >=140  & d1$srm_sodium <145] <- "140-145"
temp_ss[d1$srm_sodium >=145] <- "145>"
d1_proc$srm_sodium <- factor(temp_ss, ordered=TRUE, levels=c("<125","125-130", "130-135", "135-140","140-145","145>"))
```

##### Time

```{r}
#create copy of dataset and label each row with a corresponding time bin
temp_time <- rep("<286", nrow(d1_proc)) #285 is max time
temp_time[d1$time >=0  & d1$time <30] <- "<30"
temp_time[d1$time >=30  & d1$time <60] <- "30-60"
temp_time[d1$time >=60  & d1$time <90] <- "60-90"
temp_time[d1$time >=90  & d1$time <120] <- "90-120"
temp_time[d1$time >=120  & d1$time <150] <- "120-150"
temp_time[d1$time >=150  & d1$time <180] <- "150-180"
temp_time[d1$time >=180  & d1$time <210] <- "180-210"
temp_time[d1$time >=210  & d1$time <240] <- "210-240"
temp_time[d1$time >=240  & d1$time <270] <- "240-270"
temp_time[d1$time >=270] <- "270>"
print(temp_time)

d1_proc$time <- factor(temp_time, ordered=TRUE, levels=c("<30","30-60","60-90","90-120","120-150","150-180","180-210","210-240","240-270","270>"))
summary(d1_proc$time)
```

lets check the data types again:

```{r}
summary(d1_proc)
```

There seem to be no N/A's or transformation issues. Data pre-processing complete!

### Relationship check

Create a simple linear model to check some relationships:

```{r}
lin_mdl <- lm(heart_failure ~ age + anaemia + cpk + diabetes + ejection_fraction + high_blood_pressure + platelets + srm_creatinine + srm_sodium + sex + smoking + time, data=data.frame(d1_proc))
coef(lin_mdl)
summary(lin_mdl)
```

Not sure what to do with time here. Just took it along. The most significant effects are:

-   age

-   anaemia

-   ejection_fraction

-   serum_creatinine

-   time

Linear regression model is a bad fit -\> Multiple adjusted R-squared 0.3924.

# Model Graph structures

I've devised the following Occam's Razor model. V1.

Defining the above model in dagitty syntax:

```{r}
g1 <- graphLayout(dagitty('dag{
bb="0,0,1,1"
age [pos="0.400,0.765"]
anaemia [pos="0.626,0.325"]
cpk [pos="0.643,0.593"]
diabetes [pos="0.381,0.311"]
ejection_fraction [pos="0.521,0.323"]
heart_failure [pos="0.504,0.491"]
high_blood_pressure [pos="0.526,0.198"]
platelets [pos="0.625,0.448"]
srm_creatinine [pos="0.604,0.734"]
srm_sodium [pos="0.363,0.557"]
sex [pos="0.505,0.770"]
smoking [pos="0.526,0.082"]
time [pos="0.361,0.451"]
age_<50 -> heart_failure
age_50-60 -> heart_failure
age_60-70 -> heart_failure
age_70-80 -> heart_failure
age_80-90 -> heart_failure
age_90> -> heart_failure
anaemia -> platelets
cpk_200-400 -> heart_failure
cpk_400-600 -> heart_failure
cpk_600-800 -> heart_failure
cpk_800-1000 -> heart_failure
cpk_1000-1200 -> heart_failure
cpk_1200-1400 -> heart_failure
cpk_1400-1600 -> heart_failure
cpk_1600-1800 -> heart_failure
cpk_1800-2000 -> heart_failure
cpk_2000> -> heart_failure
diabetes -> ejection_fraction
ejection_fraction -> heart_failure
heart_failure -> srm_sodium
heart_failure -> time
high_blood_pressure -> ejection_fraction
platelets -> heart_failure
heart_failure -> srm_creatinine
sex -> heart_failure
smoking -> high_blood_pressure
}
'
))
```

```{r}
plot(g1)
```

Anemia can cause lower level of blood platelets & obesity is an unobserved variable.

# Testing Models

## Chi-square

First we perform local tests using d-separation statements to test the model.

```{r}
m <- lavCor(d1_proc)
independency_test<-localTests(g1, sample.cov=m, sample.nobs=nrow(d1_proc))
print(independency_test)

plotLocalTestResults(independency_test)
```

```{r}
independency_test2<-localTests(g1, sample.cov=m, sample.nobs=nrow(d1_proc), max.conditioning.variables = 2)
print(independency_test2)

plotLocalTestResults(independency_test2)
```

## SEM (this generates the log(pi.i) error)

```{r}
head(d1_proc)
dummy_proc <- dummy_cols(d1_proc, select_columns = c('age', 'cpk'),
           remove_selected_columns = TRUE)
polychoric <- lavCor(dummy_proc)
localTests(g1, sample.cov=polychoric, sample.nobs=nrow(dummy_proc))
status(d1_proc)
sem_model1 <- toString(g1, "lavaan")
describe(dummy_proc)
head(dummy_proc)
fit <- lavaan(sem_model1, sample.cov=polychoric, sample.nobs=nrow(dummy_proc), auto.var=TRUE, data=dummy_proc, ordered=c( "platelets", "ejection_fraction", "srm_creatinine", "srm_sodium", "time"))

lapply(lavNames(fit), function(x) class(d1_proc[,x]))
varTable(fit)
#summary(fit, standardized=TRUE)
```

Lets plot the SEM model:

```{r}
cg <- coordinates(g1)
fg <- lavaanToGraph(fit, digits = 2)
coordinates(fg) <- cg
```


```{r}
plot(fg, show.coefficients = TRUE)
```


```{r}
fit
```
